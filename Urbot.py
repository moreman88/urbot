import asyncio
import os
import logging
import sys
from dotenv import load_dotenv
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.utils.keyboard import ReplyKeyboardBuilder

# --------------------------
# üîê –£–∫–∞–∂–∏ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∑–¥–µ—Å—å
# --------------------------
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ .env —Ñ–∞–π–ª–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ)
load_dotenv()

# –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –ø–æ–∫–∞–∂–µ–º, –∫–∞–∫–æ–π Python –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
print("Using Python:", sys.executable)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –≤ –∫–æ–¥–µ)
BOT_TOKEN = os.getenv("URBOT_BOT_TOKEN")

if not BOT_TOKEN:
    raise SystemExit(
        "–û—à–∏–±–∫–∞: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è URBOT_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. "
        "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ setx –∏–ª–∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ –≤ .env) –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç."
    )

logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# --------------------------
# üìå –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
# --------------------------
def main_menu():
    kb = ReplyKeyboardBuilder()
    kb.button(text="üìò –£–ú–ö")
    kb.button(text="üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
    kb.button(text="üìÑ –ü—Ä–∏–∫–∞–∑—ã")
    kb.button(text="üìä –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å")
    kb.button(text="‚Ñπ –ü–æ–º–æ—â—å")
    kb.adjust(2, 2, 1)
    return kb.as_markup(resize_keyboard=True)

# --------------------------
# ‚ñ∂ –°—Ç–∞—Ä—Ç –±–æ—Ç–∞
# --------------------------
@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer(
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã\n\n"
        "–Ø ‚Äî *AI-–£—á–µ–±–Ω–∞—è –ß–∞—Å—Ç—å*, –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É—á–µ–±–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∫–æ–ª–ª–µ–¥–∂–∞.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_menu(),
        parse_mode="Markdown"
    )

# --------------------------
# üìò –£–ú–ö
# --------------------------
@dp.message(lambda msg: msg.text == "üìò –£–ú–ö")
async def umk_handler(message: types.Message):
    await message.answer(
        "üìò *–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –£–ú–ö*\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–º—É –£–ú–ö, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "`–ü–æ—à–∏–≤ –ø—Ä—è–º–æ–π —é–±–∫–∏`\n\n"
        "–í –±—É–¥—É—â–µ–º —è –±—É–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –£–ú–ö —á–µ—Ä–µ–∑ –ò–ò.",
        parse_mode="Markdown"
    )

# --------------------------
# üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
# --------------------------
@dp.message(lambda msg: msg.text == "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
async def schedule_handler(message: types.Message):
    await message.answer(
        "üìÖ *–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è*\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ:\n"
        "`–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –®-21 –Ω–∞ –Ω–µ–¥–µ–ª—é`\n\n"
        "–°–∫–æ—Ä–æ —è —Å–º–æ–≥—É –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –ò–ò.",
        parse_mode="Markdown"
    )

# --------------------------
# üìÑ –ü—Ä–∏–∫–∞–∑—ã
# --------------------------
@dp.message(lambda msg: msg.text == "üìÑ –ü—Ä–∏–∫–∞–∑—ã")
async def order_handler(message: types.Message):
    await message.answer(
        "üìÑ *–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–∫–∞–∑–æ–≤*\n\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        "`–ü—Ä–∏–∫–∞–∑ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã –®-31`\n\n"
        "–ü–æ–∑–¥–Ω–µ–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –ò–ò –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã—Ö –ø—Ä–∏–∫–∞–∑–æ–≤.",
        parse_mode="Markdown"
    )

# --------------------------
# üìä –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å
# --------------------------
@dp.message(lambda msg: msg.text == "üìä –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å")
async def attendance_handler(message: types.Message):
    await message.answer(
        "üìä *–ê–Ω–∞–ª–∏–∑ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏*\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ Excel –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏ —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏—Ö.\n"
        "–ü–æ–∑–¥–Ω–µ–µ –±—É–¥–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω –ò–ò –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–∞–±–ª–∏—Ü.",
        parse_mode="Markdown"
    )

# --------------------------
# ‚Ñπ –ü–æ–º–æ—â—å
# --------------------------
@dp.message(lambda msg: msg.text == "‚Ñπ –ü–æ–º–æ—â—å")
async def help_handler(message: types.Message):
    await message.answer(
        "‚Ñπ *–ü–æ–º–æ—â—å*\n\n"
        "–Ø –±–æ—Ç —É—á–µ–±–Ω–æ–π —á–∞—Å—Ç–∏ –∫–æ–ª–ª–µ–¥–∂–∞. –°–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞—é –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ, –Ω–æ –ø–æ–∑–∂–µ –±—É–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:\n"
        "‚Äî –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –£–ú–ö;\n"
        "‚Äî —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ;\n"
        "‚Äî –æ—Ñ–æ—Ä–º–ª—è—Ç—å –ø—Ä–∏–∫–∞–∑—ã;\n"
        "‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å;\n"
        "‚Äî –∑–∞–ø–æ–ª–Ω—è—Ç—å –æ—Ç—á—ë—Ç—ã.\n\n"
        "–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –ò–ò-–º–æ–¥–µ–ª—å.",
        parse_mode="Markdown"
    )

# --------------------------
# ‚ñ∂ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# --------------------------
async def main():
    logging.info("URBOT: starting polling")
    try:
        await dp.start_polling(bot)
    except Exception:
        logging.exception("Error while polling")
        raise

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except Exception:
        logging.exception("Unhandled exception on bot startup")
        raise
